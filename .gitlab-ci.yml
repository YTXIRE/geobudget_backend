stages:
  - build
  - docker
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""
  REGISTRY: "localhost:5000"
  IMAGE_NAME: "$REGISTRY/geobudget-backend"

before_script:
  - echo "üßπ Preparing..."
  - docker info

build:
  stage: build
  tags:
    - docker
  image: eclipse-temurin:24-jdk
  script:
    - ./gradlew --version
    - ./gradlew clean bootJar --stacktrace
  artifacts:
    paths:
      - build/libs/*.jar

docker_build_push:
  stage: docker
  tags:
    - docker
  image: docker:25.0.3
  services:
    - docker:25.0.3-dind
  script:
    - docker login $REGISTRY || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è"
    - docker build -t $IMAGE_NAME:latest .
    - docker push $IMAGE_NAME:latest

deploy:
  stage: deploy
  tags:
    - docker
  image: docker:25.0.3
  services:
    - docker:25.0.3-dind
  script:
    - docker pull $IMAGE_NAME:latest
    - cd $CI_PROJECT_DIR
    - docker compose down
    - docker compose up -d
