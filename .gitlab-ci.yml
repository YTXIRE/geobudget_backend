stages:
  - build
  - docker
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""               # Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ TLS Ð´Ð»Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
  REGISTRY: "localhost:5000"
  IMAGE_NAME: "$REGISTRY/geobudget-backend"
  DOCKER_HOST: "unix:///var/run/docker.sock"  # ÑÐ²Ð½Ð¾ ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ¾ÐºÐµÑ‚ Docker

before_script:
  - echo "ðŸ§¹ Preparing..."
  - docker info || echo "âš ï¸ Docker daemon Ð½Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐ¹ sudo/docker group"

build:
  stage: build
  tags:
    - docker
  image: eclipse-temurin:24-jdk
  script:
    - ./gradlew --version
    - ./gradlew clean bootJar --stacktrace
  artifacts:
    paths:
      - build/libs/*.jar

docker_build_push:
  stage: docker
  tags:
    - docker
  image: docker:25.0.3
  services:
    - docker:25.0.3-dind
  script:
    - docker info
    - docker login $REGISTRY || echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð»Ð¾Ð³Ð¸Ð½Ð¸Ñ‚ÑŒÑÑ, Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼"
    - docker build -t $IMAGE_NAME:latest .
    - docker push $IMAGE_NAME:latest

deploy:
  stage: deploy
  tags:
    - docker
  image: docker:25.0.3
  services:
    - docker:25.0.3-dind
  script:
    - docker info
    - echo "ðŸš€ Pulling image from local registry..."
    - docker pull $IMAGE_NAME:latest || echo "âš ï¸ Image Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒ build/push"

    - echo "ðŸ“‚ Switching to compose directory..."
    - cd $CI_PROJECT_DIR  # ÐµÑÐ»Ð¸ docker-compose.yml Ð»ÐµÐ¶Ð¸Ñ‚ Ð² ÐºÐ¾Ñ€Ð½Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°

    - echo "ðŸ›‘ Stopping previous containers..."
    - if command -v docker-compose >/dev/null; then docker-compose down; else docker compose down; fi

    - echo "ðŸ”„ Starting new containers..."
    - if command -v docker-compose >/dev/null; then docker-compose up -d; else docker compose up -d; fi
