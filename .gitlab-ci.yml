stages:
  - build
  - docker
  - deploy

variables:
  REGISTRY: "localhost:5000"
  IMAGE_NAME: "$REGISTRY/geobudget-backend"
  COMMIT_TAG: "$CI_COMMIT_SHORT_SHA"

# -------------------
# Build stage
# -------------------
build:
  stage: build
  tags:
    - shell   # <- Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ shell executor
  script:
    - echo "===== ðŸ§¹ START BUILD STAGE ====="
    - java -version
    - ./gradlew --version
    - ./gradlew clean bootJar --stacktrace
    - echo "âœ… Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°, jar ÑÐ¾Ð·Ð´Ð°Ð½"
    - echo "===== ðŸ§¹ END BUILD STAGE ====="
  artifacts:
    paths:
      - build/libs/*.jar

# -------------------
# Docker build & push
# -------------------
docker_build_push:
  stage: docker
  tags:
    - shell
  script:
    - echo "===== ðŸ³ START DOCKER BUILD & PUSH ====="
    - docker info
    - docker login $REGISTRY || echo "âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð»Ð¾Ð³Ð¸Ð½Ð¸Ñ‚ÑŒÑÑ"
    - docker build -t $IMAGE_NAME:latest -t $IMAGE_NAME:$COMMIT_TAG .
    - docker push $IMAGE_NAME:latest
    - docker push $IMAGE_NAME:$COMMIT_TAG
    - echo "âœ… Docker image ÑÐ¾Ð±Ñ€Ð°Ð½ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½"
    - echo "===== ðŸ³ END DOCKER BUILD & PUSH ====="

# -------------------
# Deploy stage
# -------------------
deploy:
  stage: deploy
  tags:
    - shell
  script:
    - echo "===== ðŸš€ START DEPLOY ====="
    - docker info
    - docker pull $IMAGE_NAME:latest
    - cd $CI_PROJECT_DIR
    - docker compose down || echo "âš ï¸ ÐÐµ Ð±Ñ‹Ð»Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² Ð´Ð»Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸"
    - docker compose up -d
    - echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½"
    - echo "===== ðŸš€ END DEPLOY ====="
