stages:
  - build
  - docker
  - deploy

variables:
  DOCKER_HOST: "unix:///var/run/docker.sock"
  REGISTRY: "localhost:5000"
  IMAGE_NAME: "$REGISTRY/geobudget-backend"
  COMMIT_TAG: "$CI_COMMIT_SHORT_SHA"

build:
  stage: build
  tags:
    - docker
  image: eclipse-temurin:24-jdk
  cache:
    key: gradle-cache
    paths:
      - .gradle/wrapper
      - .gradle/caches
  script:
    - echo "===== üßπ START BUILD STAGE ====="
    - echo "üëâ –ü—Ä–æ–≤–µ—Ä—è–µ–º Java..."
    - java -version
    - echo "üëâ –ü—Ä–æ–≤–µ—Ä—è–µ–º Gradle Wrapper..."
    - ./gradlew --version
    - echo "üëâ –ß–∏—Å—Ç–∏–º –ø—Ä–æ–µ–∫—Ç –∏ —Å–æ–±–∏—Ä–∞–µ–º bootJar..."
    - ./gradlew clean bootJar --stacktrace
    - echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, jar —Å–æ–∑–¥–∞–Ω"
    - echo "===== üßπ END BUILD STAGE ====="
  artifacts:
    paths:
      - build/libs/*.jar

docker_build_push:
  stage: docker
  tags:
    - docker
  image: docker:25.0.3
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock
  script:
    - echo "===== üê≥ START DOCKER BUILD & PUSH STAGE ====="
    - echo "DOCKER_HOST=$DOCKER_HOST"
    - echo "REGISTRY=$REGISTRY"
    - echo "IMAGE_NAME=$IMAGE_NAME"
    - echo "COMMIT_TAG=$COMMIT_TAG"
    - echo "üëâ –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Docker..."
    - docker info
    - echo "üëâ –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π registry (–º–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –æ—à–∏–±–∫—É)..."
    - docker login $REGISTRY || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è"
    - echo "üëâ –°–æ–±–∏—Ä–∞–µ–º Docker-–æ–±—Ä–∞–∑..."
    - docker build -t $IMAGE_NAME:latest -t $IMAGE_NAME:$COMMIT_TAG .
    - echo "üëâ –ü—É—à–∏–º Docker-–æ–±—Ä–∞–∑—ã..."
    - docker push $IMAGE_NAME:latest
    - docker push $IMAGE_NAME:$COMMIT_TAG
    - echo "‚úÖ Docker image —Å–æ–±—Ä–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω"
    - echo "===== üê≥ END DOCKER BUILD & PUSH STAGE ====="

deploy:
  stage: deploy
  tags:
    - docker
  image: docker:25.0.3
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock
  script:
    - echo "===== üöÄ START DEPLOY STAGE ====="
    - echo "DOCKER_HOST=$DOCKER_HOST"
    - echo "IMAGE_NAME=$IMAGE_NAME"
    - echo "COMMIT_TAG=$COMMIT_TAG"
    - echo "üëâ –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Docker..."
    - docker info
    - echo "üëâ –¢—è–Ω–µ–º –æ–±—Ä–∞–∑ $IMAGE_NAME:latest"
    - docker pull $IMAGE_NAME:latest
    - echo "üëâ –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞..."
    - cd $CI_PROJECT_DIR
    - echo "üëâ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
    - docker compose down || echo "‚ö†Ô∏è –ù–µ –±—ã–ª–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"
    - echo "üëâ –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
    - docker compose up -d
    - echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω"
    - echo "===== üöÄ END DEPLOY STAGE ====="
