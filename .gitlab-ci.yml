stages:
  - build
  - docker
  - deploy
  - mirror
  - notify

variables:
  REGISTRY: "localhost:5000"
  IMAGE_NAME: "$REGISTRY/geobudget-backend"
  COMMIT_TAG: "$CI_COMMIT_SHORT_SHA"
  DOCKER_TLS_CERTDIR: ""

# -------------------
# Build stage
# -------------------
build:
  stage: build
  tags:
    - shell
  image: eclipse-temurin:24-jdk
  cache:
    key: gradle-cache
    paths:
      - .gradle/wrapper
      - .gradle/caches
  script:
    - echo "===== üßπ START BUILD STAGE ====="
    - java -version
    - ./gradlew --version
    - ./gradlew clean bootJar --stacktrace
    - echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, jar —Å–æ–∑–¥–∞–Ω"
    - echo "===== üßπ END BUILD STAGE ====="
  artifacts:
    paths:
      - build/libs/*.jar

# -------------------
# Docker build & push
# -------------------
docker_build_push:
  stage: docker
  tags:
    - docker
  image: docker:25.0.3
  services: [ ]
  variables:
    DOCKER_HOST: "unix:///var/run/docker.sock"
  script:
    - echo "===== üê≥ START DOCKER BUILD ====="
    - docker info
    - docker build -t $IMAGE_NAME:latest -t $IMAGE_NAME:$COMMIT_TAG .
    - docker push $IMAGE_NAME:latest
    - docker push $IMAGE_NAME:$COMMIT_TAG
    - echo "===== üê≥ END DOCKER BUILD ====="

# -------------------
# Deploy stage
# -------------------
deploy:
  stage: deploy
  tags:
    - shell
  image: docker:25.0.3
  services: [ ]
  variables:
    DOCKER_HOST: "unix:///var/run/docker.sock"
  script:
    - echo "===== üöÄ START DEPLOY ====="
    - docker info
    - docker pull $IMAGE_NAME:latest
    - cd $CI_PROJECT_DIR
    - docker compose down || echo "‚ö†Ô∏è –ù–µ –±—ã–ª–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"
    - docker compose up -d
    - echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω"
    - echo "===== üöÄ END DEPLOY ====="

# -------------------
# Mirror to GitHub (–±–µ–∑ refs/pipelines)
# -------------------
mirror_to_github:
  stage: mirror
  image: alpine:latest
  tags:
    - shell
  variables:
    GIT_DEPTH: "0"
    GIT_PACK_THREADS: "1"
  script:
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º git –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
    - apk add --no-cache git ca-certificates

    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Git
    - git config --global user.email "codavium@gmail.com"
    - git config --global user.name "GitLab CI"

    # –î–æ–±–∞–≤–ª—è–µ–º GitHub remote
    - git remote remove github || true
    - git remote add github https://oauth2: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@github.com/YTXIRE/geobudget_backend.git

    # –û—á–∏—Å—Ç–∫–∞ –∏ —Ä–µ–ø–∞–∫–æ–≤–∫–∞ (–∏—Å–∫–ª—é—á–∞–µ—Ç –æ—à–∏–±–∫–∏ index-pack)
    - git remote prune origin || true
    - git fetch --all
    - git gc --prune=now
    - git repack -a -d --window=1

    # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ master
    - git checkout -B master

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é (–≤—Å–µ –≤–µ—Ç–∫–∏ –∏ —Ç–µ–≥–∏)
    - git push --mirror github

    - echo "‚úÖ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —É—Å–ø–µ—à–Ω–æ –∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω –Ω–∞ GitHub"
  only:
    - main
  when: on_success


# -------------------
# –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
# -------------------
notify_telegram:
  stage: notify
  image: python:3.12
  tags:
    - shell
  before_script:
    - pip install requests minio
  script:
    - python send_to_telegram.py
