stages:
  - build
  - docker
  - deploy
  - mirror

variables:
  REGISTRY: "localhost:5000"
  IMAGE_NAME: "$REGISTRY/geobudget-backend"
  COMMIT_TAG: "$CI_COMMIT_SHORT_SHA"
  DOCKER_TLS_CERTDIR: ""
  GITHUB_TOKEN: "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"

# -------------------
# Build stage
# -------------------
build:
  stage: build
  tags:
    - shell
  image: eclipse-temurin:24-jdk
  cache:
    key: gradle-cache
    paths:
      - .gradle/wrapper
      - .gradle/caches
  script:
    - echo "===== üßπ START BUILD STAGE ====="
    - java -version
    - ./gradlew --version
    - ./gradlew clean bootJar --stacktrace
    - echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, jar —Å–æ–∑–¥–∞–Ω"
    - echo "===== üßπ END BUILD STAGE ====="
  artifacts:
    paths:
      - build/libs/*.jar

# -------------------
# Docker build & push
# -------------------
docker_build_push:
  stage: docker
  tags:
    - docker
  image: docker:25.0.3
  services: []
  variables:
    DOCKER_HOST: "unix:///var/run/docker.sock"
  script:
    - echo "===== üê≥ START DOCKER BUILD ====="
    - docker info
    - docker build -t $IMAGE_NAME:latest -t $IMAGE_NAME:$COMMIT_TAG .
    - docker push $IMAGE_NAME:latest
    - docker push $IMAGE_NAME:$COMMIT_TAG
    - echo "===== üê≥ END DOCKER BUILD ====="

# -------------------
# Deploy stage
# -------------------
deploy:
  stage: deploy
  tags:
    - shell
  image: docker:25.0.3
  services: []
  variables:
    DOCKER_HOST: "unix:///var/run/docker.sock"
  script:
    - echo "===== üöÄ START DEPLOY ====="
    - docker info
    - docker pull $IMAGE_NAME:latest
    - cd $CI_PROJECT_DIR
    - docker compose down || echo "‚ö†Ô∏è –ù–µ –±—ã–ª–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"
    - docker compose up -d
    - echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω"
    - echo "===== üöÄ END DEPLOY ====="

mirror_to_github:
  stage: mirror
  tags:
    - shell
  script:
    - git config --global user.email "codavium@gmail.com"
    - git config --global user.name "GitLab CI"
    - git remote remove github || true
    - git remote add github https://oauth2:${GITHUB_TOKEN}github.com/YTXIRE/geobudget_backend.git
    - git fetch github || true
    - git push --force --mirror github
    - echo "‚úÖ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
  only:
    - main
  when: on_success