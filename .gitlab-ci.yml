stages:
  - build
  - docker
  - deploy
  - mirror
  - notify

variables:
  REGISTRY: "localhost:5000"
  IMAGE_NAME: "$REGISTRY/geobudget-backend"
  COMMIT_TAG: "$CI_COMMIT_SHORT_SHA"
  DOCKER_TLS_CERTDIR: ""

# -------------------
# Build stage
# -------------------
build:
  stage: build
  tags:
    - shell
  image: eclipse-temurin:24-jdk
  cache:
    key: gradle-cache
    paths:
      - .gradle/wrapper
      - .gradle/caches
  script:
    - echo "===== üßπ START BUILD STAGE ====="
    - java -version
    - ./gradlew --version
    - ./gradlew clean bootJar --stacktrace
    - echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, jar —Å–æ–∑–¥–∞–Ω"
    - echo "===== üßπ END BUILD STAGE ====="
  artifacts:
    paths:
      - build/libs/*.jar

# -------------------
# Docker build & push
# -------------------
docker_build_push:
  stage: docker
  tags:
    - docker
  image: docker:25.0.3
  services: [ ]
  variables:
    DOCKER_HOST: "unix:///var/run/docker.sock"
  script:
    - echo "===== üê≥ START DOCKER BUILD ====="
    - docker info
    - docker build -t $IMAGE_NAME:latest -t $IMAGE_NAME:$COMMIT_TAG .
    - docker push $IMAGE_NAME:latest
    - docker push $IMAGE_NAME:$COMMIT_TAG
    - echo "===== üê≥ END DOCKER BUILD ====="

# -------------------
# Deploy stage
# -------------------
deploy:
  stage: deploy
  tags:
    - shell
  image: docker:25.0.3
  services: [ ]
  variables:
    DOCKER_HOST: "unix:///var/run/docker.sock"
  script:
    - echo "===== üöÄ START DEPLOY ====="
    - docker info
    - docker pull $IMAGE_NAME:latest
    - cd $CI_PROJECT_DIR
    - docker compose down || echo "‚ö†Ô∏è –ù–µ –±—ã–ª–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"
    - docker compose up -d
    - echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω"
    - echo "===== üöÄ END DEPLOY ====="

# -------------------
# Mirror to GitHub (–±–µ–∑ refs/pipelines)
# -------------------
mirror_to_github:
  stage: mirror
  image: alpine/git:latest
  tags:
    - shell
  variables:
    GIT_DEPTH: "0"                  # –ü–æ–ª–Ω—ã–π clone, –∏–Ω–∞—á–µ GitHub –Ω–µ –ø—Ä–∏–º–µ—Ç push
    GIT_PACK_THREADS: "1"           # –£–º–µ–Ω—å—à–∞–µ–º –Ω–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏ —É–ø–∞–∫–æ–≤–∫–µ
  script:
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Git
    - git config --global user.email "codavium@gmail.com"
    - git config --global user.name "GitLab CI"

    # –î–æ–±–∞–≤–ª—è–µ–º GitHub remote
    - git remote remove github || true
    - git remote add github https://oauth2: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@github.com/YTXIRE/geobudget_backend.git

    # –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∏ —Ä–µ–ø–∞–∫–æ–≤–∫–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å "index-pack failed"
    - git remote prune origin || true
    - git fetch --all
    - git gc --prune=now
    - git repack -a -d --window=1

    # –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –æ—Å–Ω–æ–≤–Ω—É—é –≤–µ—Ç–∫—É
    - git checkout -B master

    # –ü–æ–ª–Ω—ã–π push –≤—Å–µ—Ö –≤–µ—Ç–æ–∫ –∏ —Ç–µ–≥–æ–≤
    - git push --mirror github

    - echo "‚úÖ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —É—Å–ø–µ—à–Ω–æ –∑–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω –Ω–∞ GitHub"
  only:
    - main
  when: on_success


# -------------------
# –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Telegram
# -------------------
notify_telegram:
  stage: notify
  image: python:3.12
  tags:
    - shell
  before_script:
    - pip install requests minio
  script:
    - python send_to_telegram.py
