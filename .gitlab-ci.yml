stages:
  - version
  - tagging
  - build
  - docker
  - deploy
  - mirror
  - upload
  - clean
  - notify


variables:
  REGISTRY: "localhost:5000"
  IMAGE_NAME: "$REGISTRY/geobudget-backend"
  COMMIT_TAG: "$CI_COMMIT_SHORT_SHA"
  DOCKER_TLS_CERTDIR: ""
  VERSION_FILE: "version.txt"
  GRADLE_USER_HOME: "/root/.gradle"
  JAVA_HOME: "/usr/lib/jvm/java-17-openjdk-amd64"

cache:
  key: "$CACHE_KEY"
  paths:
    - $GRADLE_USER_HOME
  policy: pull-push

# -------------------
# 1ï¸âƒ£ Ð’ÐµÑ€ÑÐ¸Ñ
# -------------------
versioning:
  stage: version
  image: python:3.12
  tags: [ docker ]
  variables:
    PIPELINE_START_TIME: "$CI_PIPELINE_CREATED_AT"
  before_script:
    - apt-get update && apt-get install -y tzdata
  script:
    sh versioning.sh
  artifacts:
    paths:
      - version.txt
      - version.env
    expire_in: 1 week
    reports:
      dotenv: version.env
  only:
    - branches
  except:
    - tags


# -------------------
# Tagging
# -------------------
tagging:
  stage: tagging
  tags: [ docker ]
  needs: [ versioning ]
  script:
    - sh tagging.sh
  only:
    - branches
  except:
    - tags

# -------------------
# Build stage
# -------------------
build:
  stage: build
  tags: [ docker ]
  image: eclipse-temurin:24-jdk
  cache:
    key: gradle-cache
    paths:
      - .gradle/wrapper
      - .gradle/caches
  script:
    - echo "===== ðŸ§¹ START BUILD STAGE ====="
    - java -version
    - ./gradlew --version
    - ./gradlew clean bootJar --stacktrace
    - echo "âœ… Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°, jar ÑÐ¾Ð·Ð´Ð°Ð½"
    # ÐŸÐ¾Ð´ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸Ð· version.env
    - source version.env
    - JAR_NAME="GeoBudgetBackend"
    - NEW_JAR_NAME="${JAR_NAME%.jar}-$VERSION.jar"
    - mv build/libs/"$JAR_NAME" build/libs/"$NEW_JAR_NAME"
    - echo "âœ… Jar Ð¿ÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½ Ð² $NEW_JAR_NAME"
    - echo "===== ðŸ§¹ END BUILD STAGE ====="
  artifacts:
    paths:
      - build/libs/*.jar
      - version.env
    expire_in: 1 week
  only:
    - branches
  except:
    - tags


# -------------------
# Docker build & push
# -------------------
docker_build_push:
  stage: docker
  tags: [ docker ]
  image: docker:25.0.3
  services: [ ]
  variables:
    DOCKER_HOST: "unix:///var/run/docker.sock"
  script:
    - echo "===== ðŸ³ START DOCKER BUILD ====="
    - docker info
    - docker build -t $IMAGE_NAME:latest -t $IMAGE_NAME:$COMMIT_TAG .
    - docker push $IMAGE_NAME:latest
    - docker push $IMAGE_NAME:$COMMIT_TAG
    - echo "===== ðŸ³ END DOCKER BUILD ====="

# -------------------
# Deploy stage
# -------------------
deploy:
  stage: deploy
  tags: [ docker ]
  image: docker:25.0.3
  services: [ ]
  variables:
    DOCKER_HOST: "unix:///var/run/docker.sock"
  script:
    - echo "===== ðŸš€ START DEPLOY ====="
    - docker info
    - docker pull $IMAGE_NAME:latest
    - cd $CI_PROJECT_DIR
    - docker compose down || echo "âš ï¸ ÐÐµ Ð±Ñ‹Ð»Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² Ð´Ð»Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸"
    - docker compose up -d
    - echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½"
    - echo "===== ðŸš€ END DEPLOY ====="

# -------------------
# Mirror to GitHub (Ð±ÐµÐ· refs/pipelines)
# -------------------
mirror_to_github:
  stage: mirror
  image: alpine:latest
  tags: [ docker ]
  needs:
    - job: build
      artifacts: true
  variables:
    GIT_DEPTH: "0"
  before_script:
    - apk add --no-cache git ca-certificates
    - git config --global user.email "codavium@gmail.com"
    - git config --global user.name "GitLab CI"
  script:
    - git remote remove github || true
    - git remote add github https://x-access-token:${GITHUB_TOKEN}@github.com/YTXIRE/geobudget_backend.git
    - git fetch --all --tags
    - git push github main:master
    - git push github --tags
  only:
    - main
  except:
    - tags


# -------------------
# 4ï¸âƒ£ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð² MinIO
# -------------------
upload_minio:
  stage: upload
  image: python:3.12
  tags: [ docker ]
  needs:
    - job: build
      artifacts: true
  before_script:
    - pip install minio
    - source version.env
    - echo "Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ñ€ÐµÐ»Ð¸Ð· GeoBudgetBackend_${VERSION}.jar"
  script:
    # ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ JAR, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð±Ñ‹Ð» Ð¿ÐµÑ€ÐµÐ¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½ Ñ Ð²ÐµÑ€ÑÐ¸ÐµÐ¹
    - JAR_FILE=$(ls build/libs/GeoBudgetBackend-*.jar)
    - python upload_minio.py "$JAR_FILE"
  artifacts:
    when: always
    reports:
      dotenv: version.env
    expire_in: 1 week
  only:
    - branches
  except:
    - tags



# -------------------
# 5ï¸âƒ£ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ñ€ÐµÐ»Ð¸Ð·Ð¾Ð² Ð² MinIO
# -------------------
cleanup_old_minio:
  stage: clean
  image: python:3.12
  tags: [ docker ]
  needs:
    - job: upload_minio
      artifacts: true
    - job: build           # âœ… Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ version.env
      artifacts: true
  before_script:
    - pip install minio pytz
    - source version.env
  script:
    - python cleanup_minio.py
  artifacts:
    when: always
    reports:
      dotenv: version.env
    expire_in: 1 week
  only:
    - branches
  except:
    - tags


# -------------------
# 6ï¸âƒ£ Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Telegram
# -------------------
notify_telegram:
  stage: notify
  image: python:3.12
  tags: [ docker ]
  needs:
    - job: cleanup_old_minio
      artifacts: true
    - job: build            # âœ… Ñ‚Ð¾Ð¶Ðµ Ñ‚ÑÐ½ÐµÐ¼ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ version.env
      artifacts: true
  before_script:
    - pip install requests minio pytz
    - source version.env
  script:
    - export PIPELINE_END_SEC=$(date +%s)
    - export PIPELINE_DURATION_SEC=$((PIPELINE_END_SEC - PIPELINE_START_SEC))
    - echo "PIPELINE_DURATION_SEC=$PIPELINE_DURATION_SEC" >> version.env
    - JAR_FILE=$(ls build/libs/GeoBudgetBackend-*.jar)
    - python send_to_telegram.py "$JAR_FILE"
  artifacts:
    when: always
    reports:
      dotenv: version.env
    expire_in: 1 week
  only:
    - branches
  except:
    - tags
