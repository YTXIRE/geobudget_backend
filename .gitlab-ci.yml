stages:
  - build
  - docker
  - deploy

variables:
  DOCKER_HOST: "unix:///var/run/docker.sock"
  REGISTRY: "localhost:5000"
  IMAGE_NAME: "$REGISTRY/geobudget-backend"
  COMMIT_TAG: "$CI_COMMIT_SHORT_SHA"

# -------------------
# Build stage
# -------------------
build:
  stage: build
  tags:
    - shell
  image: eclipse-temurin:24-jdk
  cache:
    key: gradle-cache
    paths:
      - .gradle/wrapper
      - .gradle/caches
  script:
    - echo "===== üßπ START BUILD STAGE ====="
    - java -version
    - ./gradlew --version
    - ./gradlew clean bootJar --stacktrace
    - echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, jar —Å–æ–∑–¥–∞–Ω"
    - echo "===== üßπ END BUILD STAGE ====="
  artifacts:
    paths:
      - build/libs/*.jar

# -------------------
# Docker build & push
# -------------------
docker_build_push:
  stage: docker
  tags:
    - shell
  script:
    - echo "===== üê≥ START DOCKER BUILD & PUSH ====="
    - docker info
    - docker login $REGISTRY || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è"
    - docker build -t $IMAGE_NAME:latest -t $IMAGE_NAME:$COMMIT_TAG .
    - docker push $IMAGE_NAME:latest
    - docker push $IMAGE_NAME:$COMMIT_TAG
    - echo "‚úÖ Docker image —Å–æ–±—Ä–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω"
    - echo "===== üê≥ END DOCKER BUILD & PUSH ====="

# -------------------
# Deploy stage
# -------------------
deploy:
  stage: deploy
  tags:
    - shell
  script:
    - echo "===== üöÄ START DEPLOY ====="
    - docker info
    - docker pull $IMAGE_NAME:latest
    - cd $CI_PROJECT_DIR
    - docker compose down || echo "‚ö†Ô∏è –ù–µ –±—ã–ª–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏"
    - docker compose up -d
    - echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω"
    - echo "===== üöÄ END DEPLOY ====="
